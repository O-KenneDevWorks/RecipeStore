name: Build and Update Expo App

# Add permissions for creating comments and releases
permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'recipestore-app/**'
      - '.github/workflows/expo-build.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Quick OTA update for minor changes
  ota-update:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    # Run for non-native changes
    if: "!contains(github.event.head_commit.message, '[native]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: recipestore-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./recipestore-app
        run: npm ci

      - name: Publish OTA Update
        working-directory: ./recipestore-app
        run: |
          eas update --auto --non-interactive
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Update published successfully
        if: success()
        run: |
          echo "âœ… OTA update published successfully!"
          echo "Your app will update automatically next time it's opened."

  # Full build for native changes (runs monthly or when [native] in commit message)
  full-build:
    name: Build APK
    runs-on: ubuntu-latest
    # Run only when [native] in commit or manual trigger
    if: contains(github.event.head_commit.message, '[native]') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: recipestore-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./recipestore-app
        run: npm ci

      - name: Build Android APK
        working-directory: ./recipestore-app
        run: |
          eas build --platform android --profile preview --non-interactive --wait
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Get Build URL
        working-directory: ./recipestore-app
        id: build-url
        run: |
          # Wait for build to be indexed
          echo "Waiting for build to be indexed..."
          sleep 10
          
          # Get the build list and check if valid
          BUILD_LIST=$(eas build:list --platform=android --limit=1 --json 2>&1)
          echo "Build list response: $BUILD_LIST"
          
          # Check if the response is valid JSON
          if echo "$BUILD_LIST" | jq empty 2>/dev/null; then
            BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].artifacts.buildUrl // ""')
            if [ -z "$BUILD_URL" ] || [ "$BUILD_URL" = "null" ]; then
              echo "âš ï¸ No build URL found in response"
              BUILD_URL="https://expo.dev/accounts/$(whoami)/projects/recipestore-app/builds"
            fi
          else
            echo "âš ï¸ Invalid JSON response from eas build:list"
            BUILD_URL="https://expo.dev/accounts/$(whoami)/projects/recipestore-app/builds"
          fi
          
          echo "Final build URL: $BUILD_URL"
          echo "url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/github-script@v7
        with:
          script: |
            const buildUrl = '${{ steps.build-url.outputs.url }}';
            const tagName = `app-v${new Date().toISOString().split('T')[0]}`;
            
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `RecipeStore App - ${tagName}`,
              body: `ðŸ“± **New APK Build Available**\n\n[Download APK](${buildUrl})\n\nInstall this on your phone to get the latest version with native changes.`,
              draft: false,
              prerelease: false
            });

      - name: Build complete
        if: success()
        run: |
          echo "âœ… APK built successfully!"
          echo "Download link available in Releases page"
