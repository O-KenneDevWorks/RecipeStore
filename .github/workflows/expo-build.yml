name: Build and Update Expo App

# Add permissions for creating comments and releases
permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - production
    paths:
      - 'recipestore-app/**'
      - '.github/workflows/expo-build.yml'
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Quick OTA update for minor changes
  ota-update:
    name: Publish OTA Update
    runs-on: ubuntu-latest
    # Run for non-native changes
    if: "!contains(github.event.head_commit.message, '[native]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: recipestore-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./recipestore-app
        run: npm ci

      - name: Publish OTA Update
        working-directory: ./recipestore-app
        run: |
          eas update --auto --non-interactive
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Update published successfully
        if: success()
        run: |
          echo "‚úÖ OTA update published successfully!"
          echo "Your app will update automatically next time it's opened."

  # Full build for native changes (runs monthly or when [native] in commit message)
  full-build:
    name: Build APK
    runs-on: ubuntu-latest
    # Run only when [native] in commit or manual trigger
    if: contains(github.event.head_commit.message, '[native]') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: recipestore-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./recipestore-app
        run: npm ci

      - name: Build Android APK
        working-directory: ./recipestore-app
        run: |
          eas build --platform android --profile preview --non-interactive --wait
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Generate Version Tag
        id: version
        working-directory: ./recipestore-app
        run: |
          # Extract version from package.json
          VERSION=$(jq -r '.version' package.json)
          # Create unique build identifier with timestamp
          BUILD_ID=$(date +%Y%m%d%H%M%S)
          # Semantic version with build metadata: v1.0.0+20260112151530
          TAG_NAME="v${VERSION}+${BUILD_ID}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG_NAME"

      - name: Download APK
        working-directory: ./recipestore-app
        run: |
          set +e  # Don't exit on error
          
          # Wait for build to be indexed
          echo "Waiting for build to be indexed..."
          sleep 10
          
          # Get the build list
          BUILD_LIST=$(eas build:list --platform=android --limit=1 --json --non-interactive 2>&1)
          EAS_EXIT_CODE=$?
          
          echo "EAS exit code: $EAS_EXIT_CODE"
          echo "Build list response: $BUILD_LIST"
          
          # Try to parse the JSON and get URL
          BUILD_URL=""
          if [ $EAS_EXIT_CODE -eq 0 ]; then
            BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].artifacts.buildUrl // ""' 2>/dev/null || echo "")
          fi
          
          # Download APK if URL is available
          if [ -n "$BUILD_URL" ] && [ "$BUILD_URL" != "null" ] && [[ "$BUILD_URL" == http* ]]; then
            echo "Downloading APK from: $BUILD_URL"
            curl -L -o RecipeStore.apk "$BUILD_URL"
            
            if [ -f "RecipeStore.apk" ]; then
              echo "‚úÖ APK downloaded successfully"
              ls -lh RecipeStore.apk
            else
              echo "‚ö†Ô∏è Failed to download APK"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Could not get valid build URL"
            exit 1
          fi
          
          set -e  # Re-enable exit on error

      - name: Create Release with APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: RecipeStore App ${{ steps.version.outputs.tag }}
          body: |
            üì± **New APK Build Available**
            
            Download the APK file below and install it on your Android device.
            
            **Installation:**
            1. Download `RecipeStore.apk` from the assets below
            2. Open the file on your phone
            3. Allow installation from unknown sources if prompted
            4. Install and enjoy!
          files: recipestore-app/RecipeStore.apk
          draft: false
          prerelease: false

      - name: Build complete
        if: success()
        run: |
          echo "‚úÖ APK built successfully!"
          echo "Download link available in Releases page"
