name: Monthly APK Build

# Add permissions for creating releases
permissions:
  contents: write

on:
  schedule:
    # Build a fresh APK on the 1st of every month at 2 AM UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  scheduled-build:
    name: Monthly APK Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: recipestore-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./recipestore-app
        run: npm ci

      - name: Build Android APK
        working-directory: ./recipestore-app
        run: |
          eas build --platform android --profile production --non-interactive --wait
        env:
          EXPO_PUBLIC_API_BASE_URL: ${{ secrets.API_BASE_URL }}

      - name: Generate Version Tag
        id: version
        working-directory: ./recipestore-app
        run: |
          # Extract version from package.json
          VERSION=$(jq -r '.version' package.json)
          # Create monthly release identifier
          YEAR_MONTH=$(date +%Y.%m)
          # Semantic version with monthly identifier: v1.0.0-monthly.2026.01
          TAG_NAME="v${VERSION}-monthly.${YEAR_MONTH}"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated tag: $TAG_NAME"

      - name: Download APK
        working-directory: ./recipestore-app
        run: |
          set +e  # Don't exit on error
          
          # Wait for build to be indexed
          echo "Waiting for build to be indexed..."
          sleep 10
          
          # Get the build list
          BUILD_LIST=$(eas build:list --platform=android --limit=1 --json --non-interactive 2>&1)
          EAS_EXIT_CODE=$?
          
          echo "EAS exit code: $EAS_EXIT_CODE"
          echo "Build list response: $BUILD_LIST"
          
          # Try to parse the JSON and get URL
          BUILD_URL=""
          if [ $EAS_EXIT_CODE -eq 0 ]; then
            BUILD_URL=$(echo "$BUILD_LIST" | jq -r '.[0].artifacts.buildUrl // ""' 2>/dev/null || echo "")
          fi
          
          # Download APK if URL is available
          if [ -n "$BUILD_URL" ] && [ "$BUILD_URL" != "null" ] && [[ "$BUILD_URL" == http* ]]; then
            echo "Downloading APK from: $BUILD_URL"
            curl -L -o RecipeStore.apk "$BUILD_URL"
            
            if [ -f "RecipeStore.apk" ]; then
              echo "‚úÖ APK downloaded successfully"
              ls -lh RecipeStore.apk
            else
              echo "‚ö†Ô∏è Failed to download APK"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Could not get valid build URL"
            exit 1
          fi
          
          set -e  # Re-enable exit on error

      - name: Create Release with APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: RecipeStore ${{ steps.version.outputs.tag }} (Monthly)
          body: |
            üì± **Monthly Production Build**
            
            Download the APK file below and install it on your Android device.
            
            ---
            
            ### Installation Instructions:
            1. Download `RecipeStore.apk` from the assets below
            2. Open the downloaded APK on your phone
            3. Allow installation from unknown sources if prompted
            4. Install and enjoy!
            
            The app will automatically get smaller updates between monthly builds!
          files: recipestore-app/RecipeStore.apk
          draft: false
          prerelease: false
